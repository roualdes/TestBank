# TestBank

To perform a quick test of the features, clone this repository and
`cd` into the directory. Then run

```
$ npm install
$ python3 main.py
```

and then in a separate window run

```
$ curl http://localhost:3000/ID
```

where `ID` can be any integer 5 or 6 (as these integers index
some embedded exercises in index.js).

## Examples

The directory `examples` contains an exam from my MATH 314 course at
[Chico State](https://www.csuchico.edu/). The .Rmd file makes calls
to `http://localhost:3000`, which must be running in order to compile
the file.

Some take aways from the example, `exam.Rmd`.

1. Exercise IDs are arbitrary and do not correspond to the numbering
   in the exam.
2. The second question in the exam makes an https request to a third
   party server to obtain a dataset.
3. The third question in the exam is produced with Python code,
   despite this being an RMarkdown document.
4. The fourth question in the exam calls a parallelized function to
   produce the output of the question.
5. I still don't know what to do with plots, so the user must deal
   with this on their end.
6. LaTeX works via MathJax, if you escape enough characters.

## Data

For now, let's simplify things in store in .json files. I'll use
[lowdb](https://github.com/typicode/lowdb) to interact with the JSON
files. There will be one file for exercises and one file for tags.
The last bit will be how each exercise is returned to the end user.

### Exercise schema

```
{
    id: "a unique ID, 4 characters long; [0-9a-zA-Z]{4}", # generated by TestBank
    language: python | r,
    setup: "code that pertains to both exercise and solution",
    exercise: "code to produce an exercise",
    solution: "code to produce a solution", # not displayed without authorization
    tags: ["tag1", ..., "tagT"] # planned but not implemented,
}
```

### Tags

If a user searches the database with a complex query such as `tags: tag1 AND (tag2 OR tag3)`, then the following secondary database should
make for more efficient searching.

```
{
    tag1: [id1, ..., idA],
    tag2: [id1, ..., idB],
    ...
    tagT: [id1, ..., idT]
}
```

After collecting the queried tags' arrays, simple set operations
should enable direct replacement of AND with `&&` and OR with `||`.

### Output schema

Each exercise will be returned from the TestBank server as a JSON
object with one of the two following structures. If an exercise
is requested, the user will receive a JSON object with the following schema

```
{
    id: "a unique ID, 4 characters long; [0-9a-zA-Z]{4}",
    seed: 1234,
    context: "the context of this exercise",
    questions: ["partA", ..., "partZ"]
}
```

If a solution is requested, the user will receive a JSON object with
the following schema

```
{
    seed: 1234,
    id: "a unique ID, 4 characters long; [0-9a-zA-Z]{4}",
    solutions: ["partA", ..., "partZ"]
}
```

There should be some sort of authorization to request a solution set.

## Writing exercises

To write an exercise, you must at least use the following structure,
inclusive of [Mustache](https://github.com/janl/mustache.js) tags:

```
{{ #exercise }}
id = '{{ ID }}'
seed = {{ SEED }}
... code to produce Output Schema
{{ /exercise }}
```

Examples exist in the [examples/
directory](https://github.com/roualdes/testbank/tree/master/examples).

### Extra Mustache tags

You can save disk space by wrapping any code that is necessary for
both the exercise and the solution into setup tags,

```
{{ #setup }}
... code necessary for both exercise and solution
{{ /setup }}
{{ #exercise }}
id = '{{ ID }}'
seeed = {{ SEED }}
... code to produce exercise Output schema
{{ /exercise }}
{{ #solution }}
... code to produce solution Output schema
{{ /solution }}
```

Examples exist in the [examples/
directory](https://github.com/roualdes/testbank/tree/master/examples).

## Checking an exercise before entering it into the database

The goal is to make entering exercises into the database as automatic
as possible, while simultaneously addressing _security_ of the TestBank
sever, _stability_ of the kernel, and _response_ time.

### Steps

1. Eyeball code for malicious content.
2. Check run time for user time approximately less 2 seconds
   `time python3 ex.py` # or
   `time Rscript ex.r`
3. Run testbank CLI

## TestBank command line interface

TestBank's GitHub repository comes with a command line interface,
`cli.js`, which attempts to help with testing exercises/solutions and
entering exercises/solutions into the database.

### Testing

To test whether or not an exercise will run (after the Mustache tags
are entered), consider the file
[examples/ex03.r](https://github.com/roualdes/testbank/tree/master/examples/ex03.r).
At the command line, with
[littler](http://dirk.eddelbuettel.com/code/littler.html)
installed/aliased as `lr` run

```
$ lr -e "$(node cli.js test examples/ex03.json exercise)"
```

If the above command runs just fine, then there's a hope that your
code will run on the TestBank kernel after being entered into the
TestBank database.

To test a Python exercise, run

```
$ node cli.js test examples/ex01.json exercise | python
```

### Inserting an exercise into TestBanks's database

To insert an exercise into TestBank's database, use the command line
interface as

```
$ node cli.js insert examples/ex03.json
```

## TODO

[x] Set up database. I'm thinking
[lowdb](https://github.com/typicode/lowdb), until something more
serious is necessary.

[] Migrate exercises to database.

[] WIP. Build a command line interface to insert exercises into the
database.

[] Server to use code from database. Exam example should be brought
back into working order.

[] CLI should have at least some check for inserting duplicate
exercises.

[] An example with code embedded in the exercise. This is likely to
get ugly.

[] Develop policy for inserting exercises into the database. Goal is
to minimize complexity of running code in kernel; maximize security,
stability, and response time.

[] Authorization for requested solutions, which, to me, implies that
exercises and their solutions are requested separately. Hmm, what of
the seed then?

[] Use query parameters and
[Mustache](https://github.com/janl/mustache.js) as way to set seed.
Validate query parameters with
[Validator](https://www.npmjs.com/package/validator).

[] Figure out versions of dependencies.

[] Develop a database searchable landing/home page for TestBank.

## Dependencies

To successfully run all of the examples, one needs

- [Node.js](https://nodejs.org/),
- [Python3](https://www.python.org/),
- [R](https://www.r-project.org/),

and the following packages within each language's ecosystem

- Use [pip](https://pip.pypa.io/en/stable/) to obtain
  - [jupyterlab](https://jupyterlab.readthedocs.io/en/stable/)
  - [numpy](https://www.numpy.org/)
  - [scipy](https://www.scipy.org/)
  - [pandas](https://pandas.pydata.org/)
- Use R's function `install.packages()` to obtain
  - [IRkernel](https://github.com/IRkernel/IRkernel)
    - After installation, in R (not RStudio), within a Terminal that
      has access to the Python envirnoment containing jupyterlab, run
      ```
      library(IRkernel)
      IRkernel::installspec()
      ```
  - [dplyr](https://dplyr.tidyverse.org/)
  - [tidyverse](https://ggplot2.tidyverse.org/)
  - [jsonlite](https://cran.r-project.org/web/packages/jsonlite/index.html)
  - [pander](https://rapporter.github.io/pander/)
  - [littler](http://dirk.eddelbuettel.com/code/littler.html)

This is my best attempt at a complete list, but I'm still iffy about
versions of everything. Let me know what I've missed.

## License

License: Open source, [BSD (3-clause)](https://opensource.org/licenses/BSD-3-Clause).
